// --- User & Identity Management ---

Table users {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(100) [not null]
  email varchar(150) [unique, not null]
  password_hash text [not null]
  role user_role [not null]
  created_at timestamp [default: `now()`]
  created_by uuid [ref: > users.id]
  force_password_change boolean [not null, default: false]
  is_active boolean [not null, default: true]
}

Table students {
  id uuid [pk, default: `gen_random_uuid()`]
  user_id uuid [unique, ref: > users.id]
  phone varchar(20)
  created_at timestamp [default: `now()`]
  student_code varchar(20) [unique]
}

Table student_year_counter {
  year integer [pk]
  counter integer [not null]
}

// --- Academic Structure ---

Table batches {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(100) [not null]
  base_fee numeric(10,2) [not null]
  start_date date
  end_date date
  created_by uuid [ref: > users.id]
  created_at timestamp [default: `now()`]
}

Table subjects {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(100) [unique, not null]
}

// --- Admissions & Financials ---

Table referencest {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(100) [unique, not null]
  concession numeric(10,2) [default: 0]
}

Table installment_plans {
  id uuid [pk, default: `gen_random_uuid()`]
  batch_id uuid [ref: > batches.id]
  months installment_months [not null]
  surcharge numeric(10,2) [default: 0]
  
  Indexes {
    (batch_id, months) [unique]
  }
}

Table admissions {
  id uuid [pk, default: `gen_random_uuid()`]
  student_id uuid [ref: > students.id]
  batch_id uuid [ref: > batches.id]
  installment_plan_id uuid [ref: > installment_plans.id]
  reference_id uuid [ref: > referencest.id]
  final_fee numeric(10,2) [not null]
  admitted_at timestamp [default: `now()`]

  Indexes {
    (student_id, batch_id) [unique]
  }
}

Table payments {
  id uuid [pk, default: `gen_random_uuid()`]
  admission_id uuid [ref: > admissions.id]
  amount numeric(10,2) [not null]
  payment_source payment_source [not null]
  receipt_number varchar(50) [unique, not null]
  paid_at timestamp [default: `now()`]
}

// --- Exams & Marks ---

Table exams {
  id uuid [pk, default: `gen_random_uuid()`]
  batch_id uuid [ref: > batches.id]
  name varchar(100) [not null]
  exam_date date [not null]
  created_at timestamp [default: `now()`]
}

Table exam_subjects {
  id uuid [pk, default: `gen_random_uuid()`]
  exam_id uuid [ref: > exams.id]
  subject_id uuid [ref: > subjects.id]
  max_marks integer [default: 100]

  Indexes {
    (exam_id, subject_id) [unique]
  }
}

Table marks {
  id uuid [pk, default: `gen_random_uuid()`]
  exam_id uuid [ref: > exams.id]
  student_id uuid [ref: > students.id]
  subject_id uuid [ref: > subjects.id]
  marks_obtained integer
  max_marks integer [default: 100]

  Indexes {
    (exam_id, student_id) [unique]
    (exam_id, student_id, subject_id) [unique]
  }
}

// --- Attendance & Location ---

Table attendance {
  id uuid [pk, default: `gen_random_uuid()`]
  batch_id uuid [not null, ref: > batches.id]
  student_id uuid [not null, ref: > students.id]
  attendance_date date [not null]
  status attendance_status [not null]
  marked_at timestamp [default: `now()`]

  Indexes {
    (batch_id, student_id, attendance_date) [unique]
  }
}

Table attendance_qr {
  id uuid [pk, default: `gen_random_uuid()`]
  token text [unique, not null]
  valid_date date [unique, not null]
  expires_at timestamp [not null]
  created_at timestamp [default: `now()`]
  created_by uuid [ref: > users.id]
}

Table campus {
  id uuid [pk, default: `gen_random_uuid()`]
  name varchar(100)
  latitude numeric(9,6) [not null]
  longitude numeric(9,6) [not null]
  radius_meters integer [not null]
}